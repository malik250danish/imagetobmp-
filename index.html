<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>JPG to BMP Converter</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .uploadSection {
        border: 2px solid blue;
        border-style: dashed;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <div class="uploadSection p-5">
            <input
              class="btn btn-primary"
              type="file"
              id="jpgFileInput"
              accept=".jpg"
            />
            <button class="btn btn-warning" id="convertButton">
              Convert to BMP
            </button>
            <a
              class="btn btn-danger my-2"
              id="downloadLink"
              style="display: none"
              >Download BMP</a
            >
            <div>
              <canvas class="w-100" id="canvas" style="display: none"></canvas>
              <img class="img-fluid" id="bmpImage" style="display: none" />
            </div>

            <h3 class="text-primary">GENERATED CODE HERE</h3>
            <textarea
              id="cArrayCode"
              class="form-control mt-3"
              rows="10"
              readonly
              style="display: none"
            ></textarea>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jimp/0.22.10/jimp.min.js"
      integrity="sha512-I7QM5mEu+5AZVAE1kZqUs1gihBFmO7h0JF6sMh5kPCatn/J2PsdsCMCtZ3FNMbutSV9WK7CSGUDukY9+MggvLA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <script>
      document
        .getElementById("convertButton")
        .addEventListener("click", async () => {
          const jpgFileInput = document.getElementById("jpgFileInput");
          const downloadLink = document.getElementById("downloadLink");
          const canvas = document.getElementById("canvas");
          const context = canvas.getContext("2d");
          const bmpImage = document.getElementById("bmpImage");
          const cArrayCode = document.getElementById("cArrayCode");

          if (jpgFileInput.files.length === 0) {
            alert("Please select a JPG file.");
            return;
          }

          const jpgFile = jpgFileInput.files[0];

          try {
            const image = await Jimp.read(URL.createObjectURL(jpgFile));

            // Resize the image to 128x64
            image.resize(128, 64);

            // Convert the image to monochrome
            image.greyscale();

            // Generate C/C++ code
            const cArrayCodeArray = [];
            image.scan(
              0,
              0,
              image.bitmap.width,
              image.bitmap.height,
              function (x, y, idx) {
                // Assuming monochrome format, with a single channel
                const pixelValue = this.bitmap.data[idx]; // Grayscale value (0-255)
                cArrayCodeArray.push(
                  `0x${pixelValue.toString(16).padStart(2, "0")}`
                );
              }
            );

            // Update C array code text area
            cArrayCode.value = cArrayCodeArray.join(", ");
            cArrayCode.style.display = "block";

            // Convert the monochrome image to a BMP
            const bmpDataURL = await image.getBase64Async(Jimp.MIME_BMP);
            bmpImage.src = bmpDataURL;
            bmpImage.style.display = "block";
            downloadLink.href = bmpDataURL;
            downloadLink.download = "output.bmp";
            downloadLink.style.display = "block";
          } catch (error) {
            alert("Error processing the image: " + error.message);
          }
        });
    </script>
  </body>
</html>
